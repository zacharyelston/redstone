[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    debug
    Parsers_File parsers.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

# Input for Docker logs via file tailing
[INPUT]
    Name             tail
    Tag              container.*
    Path             /var/lib/docker/containers/*/*.log
    Parser           docker
    Mem_Buf_Limit    5MB
    Skip_Long_Lines  On
    Refresh_Interval 5

# Docker container logs input via API
[INPUT]
    Name             docker
    Tag              docker.*

# Extract container name and add as a field
[FILTER]
    Name             record_modifier
    Match            container.*
    Record           container_name ${CONTAINER_NAME}

# Filter to extract container name from Docker container ID
[FILTER]
    Name             lua
    Match            container.*
    Script           container_name.lua
    Call             cb_extract_container_name

# Simplify container logs for better compatibility
[FILTER]
    Name             modify
    Match            container.*
    Rename           log message

# Output to Loki with dynamic labels based on container name
[OUTPUT]
    Name             loki
    Match            *
    Host             loki
    Port             3100
    Labels           job=fluentbit, container_name=${container_name}, service=redstone
    Remove_Keys      stream, time
    Line_Format      json
